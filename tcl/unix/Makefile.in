#
# src/Makefile.in  --
#
# Makefile for Extended Tcl C sources. 
# 
#------------------------------------------------------------------------------
# Copyright 1992-1995 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 4.11 1995/03/28 18:10:33 markd Exp markd $
#------------------------------------------------------------------------------
#
SHELL = /bin/sh

#------------------------------------------------------------------------------
# Autoconfig defines that can be overridden in Config.mk

CC          = @CC@
CFLAGS      = @CFLAGS@
CXX         = @CXX@
CXXFLAGS    = @CXXFLAGS@
TCLXX       = @TCLXX@
YACC        = @YACC@
RANLIB      = @RANLIB@
srcdir      = @srcdir@
srcbasedir  = @srcbasedir@
bldbasedir  = @bldbasedir@
VPATH       = @srcdir@
prefix      = @prefix@
exec_prefix = @exec_prefix@
ARCH        = @TCL_ARCH@
LIBS        = @LIBS@ @MATH_LIBS@

#------------------------------------------------------------------------------
# Include user-editable defines.

@MAKEINCLUDE@ @MAKEQUOTE@${bldbasedir}/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------

LIBTCL_A      = ${bldbasedir}/tclmaster/lib${ARCH}/libtcl.a
LIBTCLX_A     = ${bldbasedir}/tclmaster/lib${ARCH}/libtclx.a
TCL           = ${bldbasedir}/tclmaster/bin${ARCH}/tcl
TCLEXTEND_H   = ${bldbasedir}/tclmaster/include/tclExtend.h
TCLPP_H       = ${bldbasedir}/tclmaster/include/tcl++.h
APPINIT       = ${bldbasedir}/tclmaster/src/tclXAppInit.c
SYSLIBS       = ${bldbasedir}/tclmaster/src/SYSLIBS${ARCH}

LDLIBS = ${LIBTCLX_A} ${LIBTCL_A} ${LIBS}

CC_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CFLAGS} -I${srcbasedir}/src \
           -I${bldbasedir}/src -I${TCL_UCB_SRC}

CXX_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CXXFLAGS} -I${srcbasedir}/src \
           -I${bldbasedir}/src -I${TCL_UCB_SRC}

.c.o:
	${CC} ${CC_FLAGS} -c $<

#------------------------------------------------------------------------------

OBJS= \
    tclXbsearch.o    tclXchmod.o      tclXclock.o      tclXcmdInit.o \
    tclXcmdloop.o    tclXcnvclock.o   tclXdebug.o      tclXdup.o     \
    tclXfcntl.o      tclXfilecmds.o   tclXfilescan.o   tclXflock.o   \
    tclXfstat.o      tclXgeneral.o    tclXgetdate.o    tclXhandles.o \
    tclXid.o         tclXinit.o       tclXkeylist.o    tclXlib.o     \
    tclXlist.o       tclXmath.o       tclXmsgcat.o     tclXlibInit.o \
    tclXprocess.o    tclXprofile.o    tclXregexp.o     tclXselect.o  \
    tclXserver.o     tclXsignal.o     tclXshell.o      tclXstring.o  \
    tclXunixcmds.o   tclXutil.o

UCBOBJS=tclCmdIL.o

#------------------------------------------------------------------------------
# Compile the TclX library and link the shell.  If the link fails, purge
# the executable, as some systems leave invalid executables around.

all: made.tmp ${TCL} ${TCLEXTEND_H} ${TCLPP_H} ${APPINIT} ${SYSLIBS} \
     TCLXX_${TCLXX}

${TCL}: tclXAppInit.o ${LIBTCLX_A} ${LIBTCL_A} made.tmp 
	${CC} ${CC_FLAGS} ${XLDFLAGS} tclXAppInit.o ${LDLIBS} ${XLDLIBS} \
	      -o ${TCL} || (rm -f ${TCL}; exit 1)

made.tmp ${LIBTCLX_A}: ${OBJS} ${UCBOBJS}
	${AR} cr ${LIBTCLX_A} ${OBJS} ${UCBOBJS}
	${RANLIB} ${LIBTCLX_A}
	touch made.tmp

tclCmdIL.o: tclCmdIL.c ${TCL_UCB_SRC}/patchlevel.h
	MASTER=${TCL_MASTERDIR}/`../tools/tclxversion` ;\
	${CC} -c ${CC_FLAGS} -DTCL_LIBRARY=\"$$MASTER\" tclCmdIL.c

tclCmdIL.c: ${TCL_UCB_SRC}/tclCmdIL.c
	rm -f tclCmdIL.c
	echo '#include "tclXconf.h"'     > tclCmdIL.c
	cat ${TCL_UCB_SRC}/tclCmdIL.c   >> tclCmdIL.c

tclXlibInit.o: ${srcdir}/tclXlibInit.c
	MASTER=${TCL_MASTERDIR}/`../tools/tclxversion` ;\
	${CC} -c ${CC_FLAGS} -DTCLX_LIBRARY=\"$$MASTER\" \
	    ${srcdir}/tclXlibInit.c

tclXcmdInit.o: ${srcdir}/tclXcmdInit.c ${srcdir}/tclXpatchl.h

tclXgetdate.c: ${srcdir}/tclXgetdate.y
	${YACC} $(srcdir)/tclXgetdate.y
	sed 's/yy/TclXyy/g' <y.tab.c >tclXgetdate.c
	rm y.tab.c

tcl++.o: ${srcdir}/tcl++.C ${srcdir}/tcl++.h
	${CXX} -c ${CXX_FLAGS} ${srcdir}/tcl++.C
	${AR} cr ${LIBTCLX_A} tcl++.o
	${RANLIB} ${LIBTCLX_A}
	touch made.tmp

#------------------------------------------------------------------------------
# Copy include files, etc to the master directory.
#

${TCLEXTEND_H}: ${srcdir}/tclExtend.h
	rm -f ${TCLEXTEND_H}
	cp ${srcdir}/tclExtend.h ${TCLEXTEND_H}

${TCLPP_H}: ${srcdir}/tcl++.h
	rm -f ${TCLPP_H}
	cp ${srcdir}/tcl++.h ${TCLPP_H}

${APPINIT}: ${srcdir}/tclXAppInit.c
	rm -f ${APPINIT}
	cp ${srcdir}/tclXAppInit.c ${APPINIT}

${SYSLIBS}: SYSLIBS
	rm -f ${SYSLIBS}
	cp SYSLIBS ${SYSLIBS}

#------------------------------------------------------------------------------
# Make sure we can link a C++ program (the result is not install).  Target
# also forces tcl++.o to be compiled and added to the library.

TCLXX_YES: tcl++.o tcl++
TCLXX_NO:

tcl++: tclXAppInit++.o tcl++.o made.tmp
	${CXX} ${CXX_FLAGS} ${XLDFLAGS} tclXAppInit++.o \
           ${LDLIBS} ${XLDLIBS} -o tcl++

tclXAppInit++.o: ${srcdir}/tcl++.h tclXAppInit++.C
	${CXX} -c ${CXX_FLAGS} tclXAppInit++.C

tclXAppInit++.C: ${srcdir}/tclXAppInit.c
	rm -f tclXAppInit++.C
	cp ${srcdir}/tclXAppInit.c tclXAppInit++.C

#------------------------------------------------------------------------------

clean:
	-rm -f made.tmp tclXgetdate.c tclXAppInit++.C tclXAppInit.o tclCmdIL.c
	-rm -f ${OBJS} ${UCBOBJS} tclXAppInit++.o tcl++.o ${TCL} tcl++

#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	rm -f Makefile tclXconf.h SYSLIBS
