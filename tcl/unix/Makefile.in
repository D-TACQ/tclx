#
# src/Makefile.in  --
#
# Makefile for Extended Tcl C sources. 
# 
#------------------------------------------------------------------------------
# Copyright 1992-1993 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 2.20 1993/08/31 23:03:20 markd Exp markd $
#------------------------------------------------------------------------------
#
SHELL = /bin/sh

#------------------------------------------------------------------------------
# Autoconfig defines that can be overridden in Config.mk

RANLIB     = @RANLIB@
MCS        = @MCS_CMD@
srcdir     = @srcdir@
srcbasedir = @srcbasedir@
bldbasedir = @bldbasedir@
VPATH      = @srcdir@
LIBS       = @LIBS@

#------------------------------------------------------------------------------
# Include user-editable defines.

@MAKEINCLUDE@ @MAKEQUOTE@${srcbasedir}/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------

LIBTCL.A    = ../tclmaster/lib/libtcl.a
LIBTCLX.A   = ../tclmaster/lib/libtclx.a
TCL         = ../tclmaster/bin/tcl
TCLEXTEND_H = ../tclmaster/include/tclExtend.h
TCLPP_H     = ../tclmaster/include/tcl++.h

LDLIBS = ${LIBTCLX.A} ${LIBTCL.A} -lm ${LIBS}

CC_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CFLAGS} -I${srcbasedir}/src \
           -I${TCL_UCB_SRC}
 
.c.o:
	${CC} ${CC_FLAGS} -c $<

#------------------------------------------------------------------------------

OBJS= \
    tclXbsearch.o    tclXchmod.o      tclXclock.o      tclXcmdloop.o \
    tclXcnvclock.o   tclXcreate.o     tclXdebug.o      tclXdup.o     \
    tclXfcntl.o      tclXfilecmds.o   tclXfilescan.o   tclXflock.o   \
    tclXfstat.o      tclXgeneral.o    tclXgetdate.o    tclXhandles.o \
    tclXid.o         tclXkeylist.o    tclXlib.o        tclXlist.o    \
    tclXmath.o       tclXmsgcat.o     tclXprocess.o    tclXprofile.o \
    tclXregexp.o     tclXselect.o     tclXserver.o     tclXsignal.o  \
    tclXstartup.o    tclXstring.o     tclXunixcmds.o   tclXutil.o
 
#------------------------------------------------------------------------------

all: made.tmp ${TCL} ${TCLEXTEND_H} ${TCLPP_H} ${TCL_PLUS_BUILD}

${TCL}: tclXmain.o ${LIBTCLX.A} ${LIBTCL.A} made.tmp 
	${CC} ${CC_FLAGS} ${XLDFLAGS} tclXmain.o ${LDLIBS} ${XLDLIBS} -o ${TCL}
	if ${DO_STRIPPING} ; then \
	    strip ${TCL}; \
	    ${MCS} ${TCL}; \
	else \
	    exit 0 ;\
	fi

made.tmp ${LIBTCLX.A}: ${OBJS}
	${AR} cr ${LIBTCLX.A} ${OBJS} ${CPLUSOBJS}
	${RANLIB} ${LIBTCLX.A}
	touch made.tmp

tclXstartup.o: patchlevel.h tclXstartup.c
	${CC} -c ${CC_FLAGS} -DTCL_MASTERDIR=\"${TCL_MASTERDIR}\" tclXstartup.c

tclXmain.o: patchlevel.h tclXmain.c

tclXgetdate.c: tclXgetdate.y
	${YACC} $(srcdir)/tclXgetdate.y
	sed 's/yy/TclXyy/g' <y.tab.c >tclXgetdate.c
	rm y.tab.c

tcl++.o: tcl++.C tcl++.h
	${CCPLUS} -c ${CC_FLAGS} $(srcdir)/tcl++.C
	${AR} cr ${LIBTCLX.A} tcl++.o
	${RANLIB} ${LIBTCLX.A}
	touch made.tmp

#------------------------------------------------------------------------------
# Copy include files to the master directory.
#

${TCLEXTEND_H}: tclExtend.h
	rm -f ${TCLEXTEND_H}
	cp tclExtend.h ${TCLEXTEND_H}

${TCLPP_H}: tcl++.h
	rm -f ${TCLPP_H}
	cp tcl++.h ${TCLPP_H}

#------------------------------------------------------------------------------
# Make sure tcl++.h compiles, plus force tcl++.o into the library.

TCL_PLUS: tcl++ tcl++.o

tcl++: tclXmain++.o tcl++.o made.tmp
	${CCPLUS} ${CC_FLAGS} ${XLDFLAGS} tclXmain++.o ${LDLIBS} ${XLDLIBS} \
        -o tcl++

tclXmain++.o: tcl++.h tclXmain++.C
	${CCPLUS} -c -I${CPLUSINCL} ${CC_FLAGS} $(srcdir)/tclXmain++.C

#------------------------------------------------------------------------------

clean:
	-rm -f made.tmp tclXgetdate.c
	-rm -f *.o ${TCL} tcl++

#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	rm -f Makefile tclXconfig.h
