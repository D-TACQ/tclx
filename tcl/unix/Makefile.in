#
# src/Makefile.in  --
#
# Makefile for Extended Tcl C sources. 
# 
#------------------------------------------------------------------------------
# Copyright 1992-1995 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 4.13 1995/04/07 15:44:39 markd Exp markd $
#------------------------------------------------------------------------------
#
SHELL = /bin/sh

#------------------------------------------------------------------------------
# Autoconfig defines that can be overridden in Config.mk

CC          = @CC@
CFLAGS      = @CFLAGS@
CXX         = @CXX@
CXXFLAGS    = @CXXFLAGS@
TCLXX       = @TCLXX@
YACC        = @YACC@
RANLIB      = @RANLIB@
srcdir      = @srcdir@
srcbasedir  = @srcbasedir@
bldbasedir  = @bldbasedir@
VPATH       = @srcdir@
prefix      = @prefix@
exec_prefix = @exec_prefix@
ARCH        = @TCL_ARCH@
LIBS        = @LIBS@ @MATH_LIBS@

#------------------------------------------------------------------------------
# Include user-editable defines.

@MAKEINCLUDE@ @MAKEQUOTE@${bldbasedir}/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------

LIBTCL        = ${TCL_UCB_LIB}/libtcl.a
INST_MASTER   = ${TCL_MASTERDIR}/`../tools/tclxversion`
INSTCOPY      = ../runtcl ../tools/instcopy
SYMLINKEXT    = ../tools/symlinkext

LDLIBS = -L. -ltclx -L${TCL_UCB_LIB} -ltcl ${LIBS}

CC_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CFLAGS} -I${srcbasedir}/src \
           -I${bldbasedir}/src -I${TCL_UCB_SRC}

CXX_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CXXFLAGS} -I${srcbasedir}/src \
           -I${bldbasedir}/src -I${TCL_UCB_SRC}

.c.o:
	${CC} ${CC_FLAGS} -c $<

#------------------------------------------------------------------------------

OBJS= \
    tclXbsearch.o    tclXchmod.o      tclXclock.o      tclXcmdInit.o \
    tclXcmdloop.o    tclXcnvclock.o   tclXdebug.o      tclXdup.o     \
    tclXfcntl.o      tclXfilecmds.o   tclXfilescan.o   tclXflock.o   \
    tclXfstat.o      tclXgeneral.o    tclXgetdate.o    tclXhandles.o \
    tclXid.o         tclXinit.o       tclXkeylist.o    tclXlib.o     \
    tclXlist.o       tclXmath.o       tclXmsgcat.o     tclXlibInit.o \
    tclXprocess.o    tclXprofile.o    tclXregexp.o     tclXselect.o  \
    tclXserver.o     tclXsignal.o     tclXshell.o      tclXstring.o  \
    tclXunixcmds.o   tclXutil.o

UCBOBJS=tclCmdIL.o

#------------------------------------------------------------------------------
# Compile the TclX library and link the shell.  If the link fails, purge
# the executable, as some systems leave invalid executables around.

all: made.tmp tcl TCLXX_${TCLXX}

tcl: tclXAppInit.o libtclx.a ${LIBTCL} made.tmp 
	${CC} ${CC_FLAGS} ${XLDFLAGS} tclXAppInit.o ${LDLIBS} ${XLDLIBS} \
	      -o tcl || (rm -f tcl; exit 1)

made.tmp libtclx.a: ${OBJS} ${UCBOBJS}
	${AR} cr libtclx.a ${OBJS} ${UCBOBJS}
	${RANLIB} libtclx.a
	touch made.tmp

tclCmdIL.o: tclCmdIL.c ${TCL_UCB_SRC}/patchlevel.h
	${CC} -c ${CC_FLAGS} -DTCL_LIBRARY=\"${INST_MASTER}\" tclCmdIL.c

tclCmdIL.c: ${TCL_UCB_SRC}/tclCmdIL.c
	rm -f tclCmdIL.c
	echo '#include "tclXconf.h"'     > tclCmdIL.c
	cat ${TCL_UCB_SRC}/tclCmdIL.c   >> tclCmdIL.c

tclXlibInit.o: ${srcdir}/tclXlibInit.c
	${CC} -c ${CC_FLAGS} -DTCLX_LIBRARY=\"${INST_MASTER}\" \
	    ${srcdir}/tclXlibInit.c

tclXcmdInit.o: ${srcdir}/tclXcmdInit.c ${srcdir}/tclXpatchl.h

tclXgetdate.c: ${srcdir}/tclXgetdate.y
	${YACC} $(srcdir)/tclXgetdate.y
	sed 's/yy/TclXyy/g' <y.tab.c >tclXgetdate.c
	rm y.tab.c

tcl++.o: ${srcdir}/tcl++.C ${srcdir}/tcl++.h
	${CXX} -c ${CXX_FLAGS} ${srcdir}/tcl++.C
	${AR} cr libtclx.a tcl++.o
	${RANLIB} libtclx.a
	touch made.tmp

#------------------------------------------------------------------------------
# Make sure we can link a C++ program (the result is not install).  Target
# also forces tcl++.o to be compiled and added to the library.

TCLXX_YES: tcl++.o tcl++
TCLXX_NO:

tcl++: tclXAppInit++.o tcl++.o made.tmp
	${CXX} ${CXX_FLAGS} ${XLDFLAGS} tclXAppInit++.o \
           ${LDLIBS} ${XLDLIBS} -o tcl++

tclXAppInit++.o: ${srcdir}/tcl++.h tclXAppInit++.C
	${CXX} -c ${CXX_FLAGS} tclXAppInit++.C

tclXAppInit++.C: ${srcdir}/tclXAppInit.c
	rm -f tclXAppInit++.C
	cp ${srcdir}/tclXAppInit.c tclXAppInit++.C

#------------------------------------------------------------------------------

install: install-exec
	${INSTCOPY} ${srcdir}/tclExtend.h ${srcdir}/tcl++.h ${TCL_INCLUDEDIR}

install-exec:
	${INSTCOPY} tcl ${TCL_BINDIR}
	${STRIP} ${TCL_BINDIR}/tcl
	${INSTCOPY} libtclx.a ${TCL_LIBDIR}
	${RANLIB} ${TCL_LIBDIR}/libtclx.a
	${INSTCOPY} -filename SYSLIBS ${INST_MASTER}/src/SYSLIBS${ARCH}

install-master: install-master-exec
	${INSTCOPY} ${TCL_UCB_SRC}/tcl.h ${srcdir}/tclExtend.h \
	    ${srcdir}/tcl++.h ${INST_MASTER}/include
	${SYMLINKEXT} ${INST_MASTER}/include/* ${TCL_INCLUDEDIR}

install-master-exec:
	${INSTCOPY} tcl ${INST_MASTER}/bin${ARCH}
	${STRIP} ${INST_MASTER}/bin${ARCH}/tcl
	${INSTCOPY} ${LIBTCL} libtclx.a ${INST_MASTER}/lib${ARCH}
	${RANLIB} ${INST_MASTER}/lib${ARCH}/*.a
	${INSTCOPY} -filename SYSLIBS ${INST_MASTER}/src/SYSLIBS${ARCH}
	${SYMLINKEXT} ${INST_MASTER}/bin${ARCH}/* ${TCL_BINDIR}
	${SYMLINKEXT} ${INST_MASTER}/lib${ARCH}/* ${TCL_LIBDIR}

#------------------------------------------------------------------------------

clean:
	-rm -f made.tmp tclXgetdate.c tclXAppInit++.C tclXAppInit.o tclCmdIL.c
	-rm -f ${OBJS} ${UCBOBJS} tclXAppInit++.o tcl++.o tcl tcl++ libtclx.a

#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	rm -f Makefile tclXconf.h SYSLIBS
