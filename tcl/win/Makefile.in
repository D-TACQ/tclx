#
# This file is a Makefile for Tclx.  If it has the name "Makefile.in"
# then it is a template for a Makefile;  to generate the actual Makefile,
# run "./configure", which is a configuration script generated by the
# "autoconf" program (constructs like "@foo@" will get replaced in the
# actual Makefile.
#
# RCS: @(#) $Id: Makefile.in,v 1.1 1999/06/23 00:39:12 surles Exp $

TCLVERSION = @TCL_VERSION@
VERSION = @TCLX_VERSION@

#----------------------------------------------------------------
# Things you can change to personalize the Makefile for your own
# site (you can make these changes in either Makefile.in or
# Makefile, but changes to Makefile will get lost if you re-run
# the configuration script).
#----------------------------------------------------------------

# Default top-level directories in which to install architecture-
# specific files (exec_prefix) and machine-independent files such
# as scripts (prefix).  The values specified here may be overridden
# at configure-time with the --exec-prefix and --prefix options
# to the "configure" script.

prefix		= @prefix@
exec_prefix	= @exec_prefix@

# The following definition can be set to non-null for special systems
# like AFS with replication.  It allows the pathnames used for installation
# to be different than those used for actually reference files at
# run-time.  INSTALL_ROOT is prepended to $prefix and $exec_prefix
# when installing files.
INSTALL_ROOT	=

# Directory from which applications will reference the library of Tclx
# scripts (note: you can set the TCLX_LIBRARY environment variable at
# run-time to override this value):
TCLX_LIBRARY	= $(prefix)/lib/tclx$(VERSION)

# Directory in which to install the program tclxsh:
BIN_INSTALL_DIR = $(INSTALL_ROOT)$(exec_prefix)/bin

# Directory in which to install libtclx.so or libtclx.a:
LIB_INSTALL_DIR = $(INSTALL_ROOT)$(exec_prefix)/lib

# Path name to use when installing library scripts:
SCRIPT_INSTALL_DIR = $(INSTALL_ROOT)$(TCLX_LIBRARY)

# Directory in which to install the include file tclx.h:
INCLUDE_INSTALL_DIR = $(INSTALL_ROOT)$(prefix)/include

# Libraries built with optimization switches have this additional extension
TCLX_DBGX = @TCLX_DBGX@

PATHTYPE		= @PATHTYPE@

TCLX_DLL_FILE		= @TCLX_DLL_FILE@
TCLX_LIB_FILE		= @TCLX_LIB_FILE@

SRC_DIR			= @srcdir@
ROOT_DIR		= $(SRC_DIR)/..
GENERIC_DIR		= $(SRC_DIR)/../generic
COMPAT_DIR		= $(SRC_DIR)/../compat
WIN_DIR			= $(SRC_DIR)
RUNTIME_DIR		= $(SRC_DIR)/../runtime
RUNTIME_DIR_NATIVE	= "$(shell cygpath $(PATHTYPE) '$(SRC_DIR)/../runtime')"
TOOLS_DIR		= $(ROOT_DIR)/../unix/tools
BIN_DIR			= $(PWD)

TCL_LIB_FILE	  = "$(shell cygpath $(PATHTYPE) '@TCL_BIN_DIR@/@TCL_LIB_FILE@')"
TCL_STUB_LIB_FILE = "$(shell cygpath $(PATHTYPE) '@TCL_BIN_DIR@/@TCL_STUB_LIB_FILE@')"
TCL_DLL_FILE		= @TCL_DLL_FILE@
TCL_SRC_DIR		= @TCL_SRC_DIR@
TCL_BIN_DIR		= @TCL_BIN_DIR@
TCL_GENERIC_DIR		= $(TCL_SRC_DIR)/../generic
TCL_TEST_DIR		= $(TCL_SRC_DIR)/../tests
TCL_WIN_DIR		= $(TCL_SRC_DIR)/../win

TK_LIB_FILE	  = "$(shell cygpath $(PATHTYPE) '@TK_BIN_DIR@/@TK_LIB_FILE@')"
TK_STUB_LIB_FILE = "$(shell cygpath $(PATHTYPE) '@TK_BIN_DIR@/@TK_STUB_LIB_FILE@')"
TK_DLL_FILE		= @TK_DLL_FILE@
TK_SRC_DIR		= @TK_SRC_DIR@
TK_BIN_DIR		= @TK_BIN_DIR@
TK_GENERIC_DIR		= $(TK_SRC_DIR)/../generic
TK_TEST_DIR		= $(TK_SRC_DIR)/../tests
TK_WIN_DIR		= $(TK_SRC_DIR)/../win

ROOT_DIR_NATIVE	   	= $(shell cygpath $(PATHTYPE) '$(ROOT_DIR)')
WIN_DIR_NATIVE	   	= $(shell cygpath $(PATHTYPE) '$(WIN_DIR)')
GENERIC_DIR_NATIVE 	= $(shell cygpath $(PATHTYPE) '$(GENERIC_DIR)')
BIN_DIR_NATIVE		= $(shell cygpath $(PATHTYPE) "${BIN_DIR}")
TCL_GENERIC_NATIVE	= $(shell cygpath $(PATHTYPE) '$(TCL_GENERIC_DIR)')
TCL_BIN_NATIVE		= $(shell cygpath $(PATHTYPE) '$(TCL_BIN_DIR)')
TK_GENERIC_NATIVE	= $(shell cygpath $(PATHTYPE) '$(TK_GENERIC_DIR)')
TCL_WIN_NATIVE		= $(shell cygpath $(PATHTYPE) '$(TCL_WIN_DIR)')
TK_WIN_NATIVE		= $(shell cygpath $(PATHTYPE) '$(TK_WIN_DIR)')
TCL_SRC_NATIVE		= $(shell cygpath $(PATHTYPE) '$(TCL_SRC_DIR)')
TK_SRC_NATIVE		= $(shell cygpath $(PATHTYPE) '$(TK_SRC_DIR)')

SHARED_LIBRARIES 	= $(TCLX_DLL_FILE)
STATIC_LIBRARIES	= $(TCLX_LIB_FILE)

@SET_MAKE@

# Macro that expands to the first dependency argument with the appropriate
# path type already resolved.

DEPARG = "$(shell cygpath $(PATHTYPE) $<)"

# Setting the VPATH variable to a list of paths will cause the 
# makefile to look into these paths when resolving .c to .obj
# dependencies.

VPATH = $(GENERIC_DIR);$(WIN_DIR);$(COMPAT_DIR);$(TCL_GENERIC_DIR);$(TCL_WIN_DIR)

# warning flags
CFLAGS_WARNING	= @CFLAGS_WARNING@

# The default switches for optimization or debugging
CFLAGS_DEBUG    = @CFLAGS_DEBUG@
CFLAGS_OPTIMIZE	= @CFLAGS_OPTIMIZE@

# The default switches for optimization or debugging
LDFLAGS_DEBUG    = @LDFLAGS_DEBUG@
LDFLAGS_OPTIMIZE = @LDFLAGS_OPTIMIZE@

# To change the compiler switches, for example to change from optimization to
# debugging symbols, change the following line:
#CFLAGS		= $(CFLAGS_DEBUG)
#CFLAGS		= $(CFLAGS_OPTIMIZE)
#CFLAGS		= $(CFLAGS_DEBUG) $(CFLAGS_OPTIMIZE)
CFLAGS		= @CFLAGS@

AR		= @AR@
CC		= @CC@
RC		= @RC@
AC_FLAGS	= @EXTRA_CFLAGS@ @DEFS@
CPPFLAGS	= @CPPFLAGS@
LDFLAGS		= @LDFLAGS@
LDFLAGS_CONSOLE	= @LDFLAGS_CONSOLE@
LDFLAGS_WINDOW	= @LDFLAGS_WINDOW@
EXEEXT		= @EXEEXT@
OBJEXT		= @OBJEXT@
SHLIB_LD	= @SHLIB_LD@
SHLIB_LD_LIBS	= @SHLIB_LD_LIBS@ $(TCL_STUB_LIB_FILE) Wsock32.lib
SHLIB_CFLAGS	= @SHLIB_CFLAGS@
SHLIB_SUFFIX	= @SHLIB_SUFFIX@
VER		= @TCLX_MAJOR_VERSION@@TCLX_MINOR_VERSION@@TCLX_PATCH_LEVEL@
DOTVER	        = @TCLX_MAJOR_VERSION@.@TCLX_MINOR_VERSION@.@TCLX_PATCH_LEVEL@
LIBS		= @LIBS@ Wsock32.lib

CC_OBJNAME	= @CC_OBJNAME@
CC_EXENAME	= @CC_EXENAME@

CC_SWITCHES = ${CFLAGS} ${CFLAGS_WARNING} ${SHLIB_CFLAGS} \
-I"${GENERIC_DIR_NATIVE}" -I"${WIN_DIR_NATIVE}"  \
-I"${TCL_GENERIC_NATIVE}" -I"${TCL_WIN_NATIVE}"  \
${AC_FLAGS}
STUB_CC_SWITCHES = ${CC_SWITCHES} -DUSE_TCL_STUBS

RMDIR		= rm -rf
MKDIR		= mkdir -p
RM		= rm -f
COPY		= cp

TCLXSH		= tclxsh.exe
TCLXTEST	= tclxtest
CAT32		= cat32
CATTCL		= cattcl

RUN_SETUP	= PATH="$(TCL_BIN_DIR)"; export PATH; \
		  TCL_LIBRARY="$(TCL_SRC_NATIVE)/../library"; export TCL_LIBRARY; \
		  TCLX_LIBRARY="$(BIN_DIR_NATIVE)"; export TCLX_LIBRARY; \
		  TCL_PROGRAM="$(BIN_DIR_NATIVE)/$(TCLXSH)"; export TCL_PROGRAM;
RUN_TCLXSH	= $(RUN_SETUP) $(BIN_DIR)/$(TCLXSH)
RUN_TCLTEST	= $(RUN_SETUP) $(BIN_DIR)/$(TCLXTEST)
INSTCOPY	= $(RUN_TCLXSH) ./instcopy

TCLXSH_OBJS = \
	tclXAppInit.$(OBJEXT)

TCLXTEST_OBJS = \
	tclXtest.$(OBJEXT) \
	tclXwinTest.$(OBJEXT) \
	tclTest.$(OBJEXT) \
	tclWinTest.$(OBJEXT) \
	tclTestObj.$(OBJEXT)

TCLX_OBJS = \
	tclXbsearch.$(OBJEXT) \
	tclXchmod.$(OBJEXT) \
	tclXcmdInit.$(OBJEXT) \
	tclXcmdloop.$(OBJEXT) \
	tclXdebug.$(OBJEXT) \
	tclXdup.$(OBJEXT) \
	tclXfcntl.$(OBJEXT) \
	tclXfilecmds.$(OBJEXT) \
	tclXfilescan.$(OBJEXT) \
	tclXflock.$(OBJEXT) \
	tclXfstat.$(OBJEXT) \
	tclXgeneral.$(OBJEXT) \
	tclXhandles.$(OBJEXT) \
	tclXinit.$(OBJEXT) \
	tclXkeylist.$(OBJEXT) \
	tclXlgets.$(OBJEXT) \
	tclXlib.$(OBJEXT) \
	tclXlibInit.$(OBJEXT) \
	tclXlist.$(OBJEXT) \
	tclXmath.$(OBJEXT) \
	tclXmsgcat.$(OBJEXT) \
	tclXoscmds.$(OBJEXT) \
	tclXprocess.$(OBJEXT) \
	tclXprofile.$(OBJEXT) \
	tclXshell.$(OBJEXT) \
	tclXsignal.$(OBJEXT) \
	tclXsocket.$(OBJEXT) \
	tclXstring.$(OBJEXT) \
	tclXutil.$(OBJEXT) \
	tclXwinId.$(OBJEXT) \
	tclXwinCmds.$(OBJEXT) \
	tclXwinDup.$(OBJEXT) \
	tclXwinOS.$(OBJEXT) \
	random.$(OBJEXT) \
	getopt.$(OBJEXT)

TLIB_SRCS = \
	$(RUNTIME_DIR)/arrayprocs.tcl \
	$(RUNTIME_DIR)/compat.tcl \
	$(RUNTIME_DIR)/convlib.tcl \
	$(RUNTIME_DIR)/edprocs.tcl \
	$(RUNTIME_DIR)/events.tcl \
	$(RUNTIME_DIR)/forfile.tcl \
	$(RUNTIME_DIR)/globrecur.tcl \
	$(RUNTIME_DIR)/help.tcl \
	$(RUNTIME_DIR)/profrep.tcl \
	$(RUNTIME_DIR)/pushd.tcl \
	$(RUNTIME_DIR)/setfuncs.tcl \
	$(RUNTIME_DIR)/showproc.tcl \
	$(RUNTIME_DIR)/stringfile.tcl \
	$(RUNTIME_DIR)/tcllib.tcl \
	$(RUNTIME_DIR)/fmath.tcl \
	$(RUNTIME_DIR)/buildhelp.tcl

TLIB_SRCS_NATIVE= \
	$(RUNTIME_DIR_NATIVE)/arrayprocs.tcl \
	$(RUNTIME_DIR_NATIVE)/compat.tcl \
	$(RUNTIME_DIR_NATIVE)/convlib.tcl \
	$(RUNTIME_DIR_NATIVE)/edprocs.tcl \
	$(RUNTIME_DIR_NATIVE)/events.tcl \
	$(RUNTIME_DIR_NATIVE)/forfile.tcl \
	$(RUNTIME_DIR_NATIVE)/globrecur.tcl \
	$(RUNTIME_DIR_NATIVE)/help.tcl \
	$(RUNTIME_DIR_NATIVE)/profrep.tcl \
	$(RUNTIME_DIR_NATIVE)/pushd.tcl \
	$(RUNTIME_DIR_NATIVE)/setfuncs.tcl \
	$(RUNTIME_DIR_NATIVE)/showproc.tcl \
	$(RUNTIME_DIR_NATIVE)/stringfile.tcl \
	$(RUNTIME_DIR_NATIVE)/tcllib.tcl \
	$(RUNTIME_DIR_NATIVE)/fmath.tcl \
	$(RUNTIME_DIR_NATIVE)/buildhelp.tcl


all: binaries libraries doc

binaries: @LIBRARIES@ $(TCLXSH)

libraries: autoload.tcl tclx.tcl tcl.tlib tcl.tndx buildidx.tcl instcopy

doc:

$(TCLXSH): $(TCLX_LIB_FILE) $(TCLXSH_OBJS) tcl.res
	$(CC) $(CFLAGS) $(TCLXSH_OBJS) $(TCL_LIB_FILE) $(TCLX_LIB_FILE) \
	$(LIBS) $(CC_EXENAME)

$(TCLXTEST): $(TCLX_LIB_FILE) $(TCLXTEST_OBJS) tcl.res $(CAT32)
	$(CC) $(CFLAGS) $(TCLXTEST_OBJS) $(TCL_LIB_FILE) $(TCLX_LIB_FILE) \
	$(LIBS) $(CC_EXENAME)

$(CAT32): cat.c
	$(CC) -c $(CC_SWITCHES) $(DEPARG) $(CC_OBJNAME)
	$(CC) $(CFLAGS) $@.$(OBJEXT) $(CC_EXENAME) \
	-link $(LDFLAGS_CONSOLE)

$(CATTCL): cattcl.c
	$(CC) -c $(CC_SWITCHES) $(DEPARG) $(CC_OBJNAME)
	$(CC) $(CFLAGS) $@.$(OBJEXT) $(CC_EXENAME) \
	-link $(LDFLAGS_CONSOLE)

# The following targets are configured by autoconf to generate either
# a shared library or static library

${TCLX_DLL_FILE}: ${TCLX_OBJS} tcl.res
	@$(RM) ${TCLX_DLL_FILE}
	@MAKE_DLL@ ${TCLX_OBJS} tcl.res

${TCLX_LIB_FILE}: ${TCLX_OBJS}
	@$(RM) ${TCLX_LIB_FILE}
	@MAKE_LIB@ ${TCLX_OBJS}

# Special case object targets

tclXinit.$(OBJEXT): tclXinit.c
	$(CC) -c $(STUB_CC_SWITCHES) ${DEPARG} \
	-DTCLX_LIBRARY="\"$(TCLX_LIBRARY)\"" -DBUILD_TCLX \
	$(CC_OBJNAME)

tclXAppInit.$(OBJEXT): tclXAppInit.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

tclXtest.$(OBJEXT): tclXtest.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

tclXwinTest.$(OBJEXT): tclXwinTest.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

tclTest.$(OBJEXT): tclTest.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

tclWinTest.$(OBJEXT): tclWinTest.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

tclTestObj.$(OBJEXT): tclTestObj.c
	$(CC) -c $(CC_SWITCHES) ${DEPARG} $(CC_OBJNAME)

getopt.$(OBJEXT): getopt.c
	$(CC) -c $(STUB_CC_SWITCHES) -DWIN32 -DBUILD_TCLX ${DEPARG} \
	$(CC_OBJNAME)

#------------------------------------------------------------------------------
# Generate the runtime .tlib library in the current directory.  Copy other
# runtime files into this directory so it can be used as a temporary runtime
# directory before installation.  Also need a "help" directory here so that
# the help command will work before installation.  Normally just symlink,
# unless we don't have them.
#

tcl.tlib: ${TLIB_SRCS} autoload.tcl $(CATTCL)
	@$(RM) $@ 
	./$(CATTCL) ${TLIB_SRCS_NATIVE} > $@

tcl.tndx: tclx.tcl tcl.tlib buildidx.tcl
	@$(RM) $@ 
	$(RUN_TCLXSH) \
	    -q "$(shell cygpath $(PATHTYPE) '$(TOOLS_DIR)/genindex.tcl')" \
            tcl.tlib

tclx.tcl: ${RUNTIME_DIR}/tclx.tcl
	@$(RM) tclx.tcl
	$(COPY) ${RUNTIME_DIR}/tclx.tcl tclx.tcl

buildidx.tcl: ${RUNTIME_DIR}/buildidx.tcl
	@$(RM) buildidx.tcl
	$(COPY) ${RUNTIME_DIR}/buildidx.tcl buildidx.tcl

autoload.tcl: ${RUNTIME_DIR}/autoload.tcl
	@$(RM) autoload.tcl
	$(COPY) ${RUNTIME_DIR}/autoload.tcl autoload.tcl

instcopy: $(TOOLS_DIR)/buildutil.tcl $(TOOLS_DIR)/instcopy.tcl $(CATTCL)
	@$(RM) instcopy
	./$(CATTCL) \
	    "$(shell cygpath $(PATHTYPE) '$(TOOLS_DIR)/buildutil.tcl')" \
	    "$(shell cygpath $(PATHTYPE) '$(TOOLS_DIR)/instcopy.tcl')" > $@

# Add the object extension to the implicit rules.  By default .obj is not
# automatically added.

.SUFFIXES: .${OBJEXT}
.SUFFIXES: .res
.SUFFIXES: .rc

# Implicit rule for all object files that will end up in the Tclx library

.c.${OBJEXT}:
	$(CC) -c $(STUB_CC_SWITCHES) -DBUILD_TCLX ${DEPARG} $(CC_OBJNAME)

.rc.res:
	$(RC) -fo $@ -r -i "$(GENERIC_DIR_NATIVE)" -i "$(WIN_DIR_NATIVE)" $(DEPARG)

install: all install-binaries install-libraries install-doc

install-binaries:
	@for i in $(BIN_INSTALL_DIR) $(LIB_INSTALL_DIR); \
	    do \
	    if [ ! -d $$i ] ; then \
		echo "Making directory $$i"; \
		$(MKDIR) $$i; \
		fi; \
	    done;
	@for i in $(TCLXSH) $(TCLX_DLL_FILE); \
	    do \
	    if [ -f $$i ]; then \
		echo "Installing into $(BIN_INSTALL_DIR) $$i"; \
		$(COPY) $$i "$(BIN_INSTALL_DIR)"; \
	    fi; \
	    done
	@for i in $(TCLX_LIB_FILE) ; \
	    do \
	    if [ -f $$i ]; then \
		echo "Installing into $(LIB_INSTALL_DIR) $$i"; \
		$(COPY) $$i "$(LIB_INSTALL_DIR)"; \
	    fi; \
	    done

install-libraries:
	@for i in $(INCLUDE_INSTALL_DIR) $(SCRIPT_INSTALL_DIR); \
	    do \
	    if [ ! -d $$i ] ; then \
		echo "Making directory $$i"; \
		$(MKDIR) $$i; \
		fi; \
	    done;
	@for i in $(GENERIC_DIR)/tclExtend.h ; \
	    do \
	    if [ -f $$i ]; then \
		echo "Installing into $(INCLUDE_INSTALL_DIR) $$i"; \
		$(COPY) $$i "$(INCLUDE_INSTALL_DIR)"; \
	    fi; \
	    done
	@for i in tcl.tlib tcl.tndx tclx.tcl buildidx.tcl autoload.tcl; \
	    do \
	    if [ -f $$i ]; then \
		echo "Installing into $(SCRIPT_INSTALL_DIR) $$i"; \
		$(COPY) $$i "$(SCRIPT_INSTALL_DIR)"; \
	    fi; \
	    done
	@$(RM) ./tclXTempPkgIndexFile
	@echo " \
	lassign \$$argv indexPath dllName ; \
	set dllPath  [file join .. bin \$$dllName] ; \
	set fd       [open \$$indexPath w] ; \
	set version  [package require Tcl] ; \
	set xversion [package require Tclx] ; \
	puts \$$fd \"# Tcl package index file, version 1.0\" ; \
	puts \$$fd \"#\" ; \
	puts \$$fd \"# Package index for TclX \$$xversion.\" ; \
	puts \$$fd \"#\" ; \
	puts \$$fd \"if \{\[catch {package require Tcl \$$version\}\]\} \{\" ;\
	puts \$$fd \"    return\" ; \
	puts \$$fd \"}\" ; \
	puts \$$fd \"package ifneeded Tclx \$$xversion \\\\\" ; \
	puts \$$fd \"\\t\[list load \[file join \\$$dir \$$dllPath] Tclx]\" ; \
	close \$$fd ; \
	" >> ./tclXTempPkgIndexFile
	@echo "installing into $(SCRIPT_INSTALL_DIR) pkgIndex.tcl"
	@$(RUN_TCLXSH) -q  ./tclXTempPkgIndexFile \
		"$(SCRIPT_INSTALL_DIR)/pkgIndex.tcl" "$(TCLX_DLL_FILE)"
	@$(RM) ./tclXTempPkgIndexFile

install-doc:
	@echo "installing into $(SCRIPT_INSTALL_DIR)/help help"
	@$(INSTCOPY) $(ROOT_DIR)/help "$(SCRIPT_INSTALL_DIR)/help"

test: all $(TCLXTEST) $(CAT32)
	(cd "$(ROOT_DIR_NATIVE)\tests"; $(RUN_TCLTEST) all $(TESTFLAGS)) \
	| ./$(CAT32)

runtest: all $(TCLXTEST)
	(cd "$(ROOT_DIR_NATIVE)\tests"; $(RUN_TCLTEST))

runtclxsh: all $(TCLXSH)
	$(RUN_TCLXSH)

depend:

clean:
	$(RM) *.${OBJEXT}
	$(RM) *~ \#* TAGS a.out
	$(RM) tcl.tlib tcl.tndx tclx.tcl buildidx.tcl
	$(RM) autoload.tcl instcopy
	$(RM) *.exp *.lib *.exe *.def *.res *.pch *.pdb *.ilk
	$(RM) $(TCLX_LIB_FILE) $(TCLX_DLL_FILE)
	$(RM) $(TCLXSH) $(TCLXTEST) $(CAT32) $(CATTCL)

distclean: clean
	$(RM) Makefile config.status config.cache config.log

Makefile: Makefile.in
	./config.status
