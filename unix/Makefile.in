#
# Makefile --
#
# Makefile for Extended Tcl.  This requires Tcl 6.1 or Tcl 6.2 from Berkeley,
# which should be compiled before running this makefile.  Its location is
# configured below.
# 
#------------------------------------------------------------------------------
# Copyright 1992 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile,v 1.3 1992/09/21 00:17:57 markd Exp markd $
#------------------------------------------------------------------------------
#

include Config.mk
include config/$(TCL_CONFIG_FILE)
SHELL=/bin/sh

#------------------------------------------------------------------------------

# List of files that are touched by secondary makefiles when something changes.

MADE.FILES=ucbsrc/made.tmp osSupport/made.tmp src/made.tmp
TKMADE.FILES=tkucbsrc/made.tmp

CFLAGS= $(OPTIMIZE_FLAG) $(XCFLAGS) -I$(TCL_UCB_DIR) $(MEM_DEBUG_FLAGS) \
        $(SYS_DEP_FLAGS)

#------------------------------------------------------------------------------

all: tcl TCLDEFAULT $(TCL_TK_SHELL)


#------------------------------------------------------------------------------
# Compile the Extended Tcl library and link the Tcl shell.
#

tcl: libtcl.a
	cd ucbsrc;    $(MAKE) -$(MAKEFLAGS) all
	cd osSupport; $(MAKE) -$(MAKEFLAGS) all
	cd tclsrc;    $(MAKE) -$(MAKEFLAGS) all
	cd src;       $(MAKE) -$(MAKEFLAGS) all


# Copy the UCB libtcl.a file from where it was built.  Force the other
# Makefiles to add their .o files to the library by nuking their made.tmp file.

libtcl.a: $(TCL_UCB_DIR)/libtcl.a
	cp $(TCL_UCB_DIR)/libtcl.a .
	rm -f  $(MADE.FILES)

#------------------------------------------------------------------------------
# Generate a libtk.a with extensions and a wish shell with Extended Tcl
# commands.
#

wish: libtk.a
	cd tkucbsrc; $(MAKE) -$(MAKEFLAGS) all
	cd tksrc;    $(MAKE) -$(MAKEFLAGS) all


# Copy the UCB libtk.a file.  Force the other Makefiles to add their
# .o files to the library by nuking their made.tmp file.

libtk.a: $(TCL_TK_DIR)/libtk.a
	cp $(TCL_TK_DIR)/libtk.a libtk.a
	rm -f $(TKMADE.FILES)


#------------------------------------------------------------------------------
# Generate a temporary TCLDEFAULT file so Tcl can be run in this directory.

TCLDEFAULT:
	@echo "	- Generating temporary TCLDEFAULT file -"
	@echo '# Temporary TCLDEFAULT file for debugging'  >TCLDEFAULT
	@echo "set TCLPATH `pwd`/tcllib"                  >>TCLDEFAULT
	@echo "set TCLINIT `pwd`/tcllib/TclInit.tcl"      >>TCLDEFAULT


#------------------------------------------------------------------------------
#
#  just test to see if the C++ include file compiles and links

tcl++:
	cd src;$(MAKE) -$(MAKEFLAGS) TCL++

#------------------------------------------------------------------------------
#
# Run the UCB and Extended Tcl tests.

test: ucbtests extdtests

ucbtests: all
	./tcl -c "cd $(TCL_UCB_DIR)/tests;source all"

extdtests: all
	./tcl -c "cd tests;source all"	

#------------------------------------------------------------------------------
# Install Tcl.

install: all
	./tcl tclsrc/installTcl.tcl


#------------------------------------------------------------------------------
# Clean up the mess we made.

clean:
	cd ucbsrc;    $(MAKE) -$(MAKEFLAGS) clean
	cd osSupport; $(MAKE) -$(MAKEFLAGS) clean
	cd src;       $(MAKE) -$(MAKEFLAGS) clean
	cd tclsrc;    $(MAKE) -$(MAKEFLAGS) clean
	cd tkucbsrc;  $(MAKE) -$(MAKEFLAGS) clean
	cd tksrc;     $(MAKE) -$(MAKEFLAGS) clean
	-rm -f libtcl.a TCLDEFAULT libtk.a
