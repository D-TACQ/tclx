#
# Makefile --
#
# Top-level makefile for Extended Tcl.
# 
#------------------------------------------------------------------------------
# Copyright 1992 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile,v 2.5 1993/06/21 06:15:01 markd Exp markd $
#------------------------------------------------------------------------------
#

include Config.mk
include config/${TCL_CONFIG_FILE}

SHELL=/bin/sh

#------------------------------------------------------------------------------

CFLAGS = ${OPTIMIZE_FLAG} ${XCFLAGS} -I${TCL_UCB_DIR} ${MEM_DEBUG_FLAGS} \
         ${SYS_DEP_FLAGS}

#------------------------------------------------------------------------------

all: TCLX runtcl ${TK_BUILD}


#------------------------------------------------------------------------------
# Compile the Extended Tcl library and link the Tcl shell.
#

TCLX: TCLCOPY runtcl
#???	cd ucbsrc;    ${MAKE} -${MAKEFLAGS} all
	cd osSupport; ${MAKE} -${MAKEFLAGS} all
	cd src;       ${MAKE} -${MAKEFLAGS} all
	cd tclsrc;    ${MAKE} -${MAKEFLAGS} all

#------------------------------------------------------------------------------
# Copy include and library files from the UCB Tcl distribution to the
# tclmaster directory.
#
LIBTCL.A = tclmaster/lib/libtcl.a
TCL.H    = tclmaster/include/tcl.h

TCLCOPY: MKTCLDIRS ${LIBTCL.A} ${TCL.H}

MKTCLDIRS:
	-mkdir tclmaster         2>/dev/null; exit 0
	-mkdir tclmaster/lib     2>/dev/null; exit 0
	-mkdir tclmaster/include 2>/dev/null; exit 0
	-mkdir tclmaster/bin     2>/dev/null; exit 0

${LIBTCL.A}: ${TCL_UCB_DIR}/libtcl.a
	rm -f ${LIBTCL.A}
	cp ${TCL_UCB_DIR}/libtcl.a ${LIBTCL.A}
	${RANLIB_CMD} ${LIBTCL.A}

${TCL.H}: ${TCL_UCB_DIR}/tcl.h
	rm -f ${TCL.H}
	cp ${TCL_UCB_DIR}/tcl.h ${TCL.H}

#------------------------------------------------------------------------------
# Generate a wish shell {wishx} with Extended Tcl commands.
#

WISHX: TKCOPY runwishx
#????	cd tkucbsrc; ${MAKE} -${MAKEFLAGS} all
	cd tksrc;    ${MAKE} -${MAKEFLAGS} all
	cd tktclsrc; ${MAKE} -${MAKEFLAGS} all

#------------------------------------------------------------------------------
# Copy include and library files from the UCB Tk distribution to the
# tkmaster directory.
#
LIBTK.A  = tkmaster/lib/libtk.a
TK.H     = tclmaster/include/tk.h

TKCOPY: MKTKDIRS ${LIBTK.A} ${TK.H}

MKTKDIRS:
	-mkdir tkmaster         2>/dev/null; exit 0
	-mkdir tkmaster/lib     2>/dev/null; exit 0
	-mkdir tkmaster/include 2>/dev/null; exit 0
	-mkdir tkmaster/bin     2>/dev/null; exit 0

${LIBTK.A}: ${TK_UCB_DIR}/libtk.a
	rm -f ${LIBTK.A}
	cp ${TK_UCB_DIR}/libtk.a ${LIBTK.A}
	${RANLIB_CMD} ${LIBTK.A}

${TK.H}: ${TK_UCB_DIR}/tk.h
	rm -f ${TK.H}
	cp ${TK_UCB_DIR}/tk.h ${TK.H}

#------------------------------------------------------------------------------
# Generate scripts to point the TCL_LIBRARY/TK_LIBRARY environment variable at
# the local master directories so tcl & wishx can be run before installing.

runtcl:
	@echo ':'                                              >runtcl
	@echo '# script for testing Tcl before installation'  >>runtcl
	@echo "TCL_LIBRARY=`pwd`/tclmaster"                   >>runtcl
	@echo "export TCL_LIBRARY"                            >>runtcl
	@echo "if [ \$$# = 0 ]"                               >>runtcl
	@echo "then"                                          >>runtcl
	@echo "    exec `pwd`/tclmaster/bin/tcl"              >>runtcl
	@echo "else"                                          >>runtcl
	@echo "    exec `pwd`/tclmaster/bin/tcl \"\$$@\""     >>runtcl
	@echo "fi"                                            >>runtcl
	chmod a+rx runtcl

runwishx:
	@echo ':'                                               >runwishx
	@echo '# script for testing wishx before installation' >>runwishx
	@echo "TCL_LIBRARY=`pwd`/tclmaster"                    >>runwishx
	@echo "export TCL_LIBRARY"                             >>runwishx
	@echo "TK_LIBRARY=`pwd`/tkmaster"                      >>runwishx
	@echo "export TK_LIBRARY"                              >>runwishx
	@echo "if [ \$$# = 0 ]"                                >>runwishx
	@echo "then"                                           >>runwishx
	@echo "    exec `pwd`/tkmaster/bin/wishx"              >>runwishx
	@echo "else"                                           >>runwishx
	@echo "    exec `pwd`/tkmaster/bin/wishx \"\$$@\""     >>runwishx
	@echo "fi"                                             >>runwishx
	chmod a+rx runwishx

#------------------------------------------------------------------------------
# Test to see if the C++ include file compiles and links.

tcl++:
	cd src;${MAKE} -${MAKEFLAGS} tcl++

#------------------------------------------------------------------------------
# Run the UCB and Extended Tcl tests.

test: ucbtests extdtests

ucbtests: all
	./runtcl -c "cd ${TCL_UCB_DIR}/tests;source all"

extdtests: all
	./runtcl -c "cd tests;source all"	

tktest: all
	cd tests ; ../runwishx -f tktests.tcl -n wish ../${TK_UCB_DIR}

#------------------------------------------------------------------------------
# Rebuild help files.  The are shipped with TclX, but can be rebuilt if Tcl or
# Tk versions have changed.

buildtclhelp:
	cd tclsrc;   ${MAKE} -${MAKEFLAGS} buildtclhelp

buildtkhelp:
	cd tktclsrc; ${MAKE} -${MAKEFLAGS} buildtkhelp

#------------------------------------------------------------------------------
# Install Tcl.

install: all
	./runtcl tclsrc/installTcl.tcl

#------------------------------------------------------------------------------
# Clean up the mess we made.

clean:
	cd ucbsrc;    ${MAKE} -${MAKEFLAGS} clean
	cd osSupport; ${MAKE} -${MAKEFLAGS} clean
	cd src;       ${MAKE} -${MAKEFLAGS} clean
	cd tclsrc;    ${MAKE} -${MAKEFLAGS} clean
	cd tkucbsrc;  ${MAKE} -${MAKEFLAGS} clean
	cd tksrc;     ${MAKE} -${MAKEFLAGS} clean
	cd tktclsrc;  ${MAKE} -${MAKEFLAGS} clean
	-rm -f runtcl runwishx
	-rm -rf tclmaster/bin tclmaster/lib tclmaster/include
	-rm -rf tkmaster/bin tkmaster/lib tkmaster/include
