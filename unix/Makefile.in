#
# Makefile --
#
# Makefile for Extended Tcl.  This requires Tcl 6.1 or Tcl 6.2 from Berkeley,
# which should be compiled before running this makefile.  Its location is
# configured below.
# 
#------------------------------------------------------------------------------
# Copyright 1992 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile,v 2.2 1993/02/18 03:53:53 markd Exp markd $
#------------------------------------------------------------------------------
#

include Config.mk
include config/$(TCL_CONFIG_FILE)
SHELL=/bin/sh

#------------------------------------------------------------------------------

# List of files that are touched by secondary makefiles when something changes.

MADE.FILES=ucbsrc/made.tmp osSupport/made.tmp src/made.tmp
TKMADE.FILES=tkucbsrc/made.tmp

CFLAGS= $(OPTIMIZE_FLAG) $(XCFLAGS) -I$(TCL_UCB_DIR) $(MEM_DEBUG_FLAGS) \
        $(SYS_DEP_FLAGS)

#------------------------------------------------------------------------------

all: tcl runtcl $(TCL_TK_SHELL)


#------------------------------------------------------------------------------
# Compile the Extended Tcl library and link the Tcl shell.
#

tcl: TCLX_MAKES

TCLX_MAKES: libtcl.a
	cd ucbsrc;    $(MAKE) -$(MAKEFLAGS) all
	cd osSupport; $(MAKE) -$(MAKEFLAGS) all
	cd tclsrc;    $(MAKE) -$(MAKEFLAGS) all
	cd src;       $(MAKE) -$(MAKEFLAGS) all


# Copy the UCB libtcl.a file from where it was built.  Force the other
# Makefiles to add their .o files to the library by nuking their made.tmp file.

libtcl.a: $(TCL_UCB_DIR)/libtcl.a
	cp $(TCL_UCB_DIR)/libtcl.a libtcl.a
	$(RANLIB_CMD) libtcl.a
	rm -f $(MADE.FILES)

#------------------------------------------------------------------------------
# Generate a libtk.a with extensions and a wish shell (wishx) with Extended Tcl
# commands.
#

wishx: TKX_MAKES runwishx

TKX_MAKES: libtk.a
	cd tkucbsrc; $(MAKE) -$(MAKEFLAGS) all
	cd tksrc;    $(MAKE) -$(MAKEFLAGS) all

# Copy the UCB libtk.a file.  Force the other Makefiles to add their
# .o files to the library by nuking their made.tmp file.

libtk.a: $(TCL_TK_DIR)/libtk.a
	cp $(TCL_TK_DIR)/libtk.a libtk.a
	$(RANLIB_CMD) libtk.a
	rm -f $(TKMADE.FILES)


#------------------------------------------------------------------------------
# Also a script to point the TCLINIT environment variable at the local tcllib
# directory so tcl can be run before installing.

runtcl:
	@echo ':'                                              >runtcl
	@echo '# script for testing Tcl before installation'  >>runtcl
	@echo "TCLINIT=`pwd`/tcllib/TclInit.tcl"              >>runtcl
	@echo "export TCLINIT"                                >>runtcl
	@echo "if [ \$$# = 0 ]"                               >>runtcl
	@echo "then"                                          >>runtcl
	@echo "    exec `pwd`/tcl"                            >>runtcl
	@echo "else"                                          >>runtcl
	@echo "    exec `pwd`/tcl \"\$$@\""                   >>runtcl
	@echo "fi"                                            >>runtcl
	chmod a+rx runtcl

runwishx:
	@echo ':'                                               >runwishx
	@echo '# script for testing wishx before installation' >>runwishx
	@echo "TCLINIT=`pwd`/tcllib/TclInit.tcl"               >>runwishx
	@echo "export TCLINIT"                                 >>runwishx
	@echo "TK_LIBRARY=`pwd`/$(TCL_TK_DIR)/library"         >>runwishx
	@echo "export TK_LIBRARY"                              >>runwishx
	@echo "if [ \$$# = 0 ]"                                >>runwishx
	@echo "then"                                           >>runwishx
	@echo "    exec `pwd`/wishx"                           >>runwishx
	@echo "else"                                           >>runwishx
	@echo "    exec `pwd`/wishx \"\$$@\""                  >>runwishx
	@echo "fi"                                             >>runwishx
	chmod a+rx runwishx

#------------------------------------------------------------------------------
# Test to see if the C++ include file compiles and links.

tcl++:
	cd src;$(MAKE) -$(MAKEFLAGS) TCL++

#------------------------------------------------------------------------------
# Run the UCB and Extended Tcl tests.

test: ucbtests extdtests

ucbtests: all
	@echo ""
	@echo "**************************************************"
	@echo "* Ignore failures in tests:  expr-2.2 & expr-2.6 *"
	@echo "**************************************************"
	@echo ""
	./runtcl -c "cd $(TCL_UCB_DIR)/tests;source all"

extdtests: all
	./runtcl -c "cd tests;source all"	

#------------------------------------------------------------------------------
# Build help for Tk.

buildtkhelp:
	./runtcl tclsrc/bldtkhelp.tcl  $(TCL_TK_DIR)

#------------------------------------------------------------------------------
# Install Tcl.

install: all
	./runtcl tclsrc/installTcl.tcl


#------------------------------------------------------------------------------
# Clean up the mess we made.

clean:
	cd ucbsrc;    $(MAKE) -$(MAKEFLAGS) clean
	cd osSupport; $(MAKE) -$(MAKEFLAGS) clean
	cd src;       $(MAKE) -$(MAKEFLAGS) clean
	cd tclsrc;    $(MAKE) -$(MAKEFLAGS) clean
	cd tkucbsrc;  $(MAKE) -$(MAKEFLAGS) clean
	cd tksrc;     $(MAKE) -$(MAKEFLAGS) clean
	-rm -f libtcl.a libtk.a runtcl runwishx tkhelp.tmp
