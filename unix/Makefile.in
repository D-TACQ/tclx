#
# Makefile --
#
# Top-level Unix makefile for Extended Tcl.
# 
#------------------------------------------------------------------------------
# Copyright 1992-1996 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 5.6 1996/02/16 18:05:11 markd Exp $
#------------------------------------------------------------------------------
#

#------------------------------------------------------------------------------
# Common and user-editable defines.
#
srcdir = @srcdir@

@MAKEINCLUDE@ @MAKEQUOTE@@bldbasedir@/unix/Common.mk@MAKEQUOTE@
@MAKEINCLUDE@ @MAKEQUOTE@@bldbasedir@/unix/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------
# Flags that were passed on the command line that are to be passed on to
# second level makes.

PASS_FLAGS = "CC=${CC}" "CFLAGS=${CFLAGS}" "LDFLAGS=${LDFLAGS}"

#------------------------------------------------------------------------------

all: COMP_TCLX COMP_${TK_BUILD}

COMP_TCLX: COMP_TOOLS runtcl
	cd ../tcl/unix; ${MAKE} all

COMP_WISHX: COMP_TOOLS runwishx
	cd ../tk/unix; ${MAKE} ${PASS_FLAGS} all

COMP_:

COMP_TOOLS:
	cd tools; ${MAKE} ${PASS_FLAGS} all

#------------------------------------------------------------------------------
# Generate scripts to point the TCLX_LIBRARY/TKX_LIBRARY environment variable
# at the local runtime directories so tcl & wishx can be run before installing.

runtcl: Makefile
	@echo '#!/bin/sh'                                           >runtcl
	@echo '# script for testing Tcl before installation'       >>runtcl
	@echo "TCLX_LIBRARY=${TCLX_TMP_RUNTIME}"                   >>runtcl
	@echo "TCL_PROGRAM=${TCLX_UNIX_BLD_DIR}/tcl"               >>runtcl
	@echo "export TCLX_LIBRARY TCL_PROGRAM"                    >>runtcl
	@echo "if [ \$$# = 0 ]"                                    >>runtcl
	@echo "then"                                               >>runtcl
	@echo "    exec \$$TCL_PROGRAM"                            >>runtcl
	@echo "else"                                               >>runtcl
	@echo "    exec \$$TCL_PROGRAM \"\$$@\""                   >>runtcl
	@echo "fi"                                                 >>runtcl
	chmod a+rx runtcl

runwishx: Makefile
	@echo '#!/bin/sh'                                          >runwishx
	@echo '# script for testing wishx before installation'    >>runwishx
	@echo "TCLX_LIBRARY=${TCLX_TMP_RUNTIME}"                  >>runwishx
	@echo "TKX_LIBRARY=${TKX_TMP_RUNTIME}"                    >>runwishx
	@echo "TCL_PROGRAM=${TCLX_UNIX_BLD_DIR}/tcl"              >>runwishx
	@echo "WISHX=${TKX_UNIX_BLD_DIR}/wishx"                   >>runwishx
	@echo "export TCLX_LIBRARY TKX_LIBRARY TCL_PROGRAM"       >>runwishx
	@echo "if [ \$$# = 0 ]"                                   >>runwishx
	@echo "then"                                              >>runwishx
	@echo "    exec \$$WISHX"                                 >>runwishx
	@echo "else"                                              >>runwishx
	@echo "    exec \$$WISHX \"\$$@\""                        >>runwishx
	@echo "fi"                                                >>runwishx
	chmod a+rx runwishx

#------------------------------------------------------------------------------
# Relink using shared libraries.  The libraries must be built and installed
# by hand.

shlink: TCL_SHLINK SHLINK_${TK_BUILD}

TCL_SHLINK:
	cd src; ${MAKE} shlink

SHLINK_WISHX:
	cd tksrc; ${MAKE} shlink

SHLINK_:

#------------------------------------------------------------------------------
# Run the tests.

test: all
	cd ../tcl/unix; ${MAKE} test

ucbtests: all
	cd ../tcl/unix; ${MAKE} ucbtests

extdtests: all
	cd ../tcl/unix; ${MAKE} extdtests

tktest: all
	cd ../tk/unix;  ${MAKE} test

#------------------------------------------------------------------------------
# Rebuild help files.  The are shipped with TclX, but can be rebuilt if Tcl or
# Tk versions have changed.
#
buildhelp:
	cd ../tcl/unix; ${MAKE} buildhelp
	cd ../tk/unix;  ${MAKE} buildhelp

#------------------------------------------------------------------------------
# Install Extended Tcl.
#
install: all TCLXINSTALL INST_${TK_BUILD}

install-exec: all TCLXINSTALL_EXEC INST_EXEC_${TK_BUILD}

TCLXINSTALL:
	cd ../tcl/unix; ${MAKE} install

TCLXINSTALL_EXEC:
	cd ../tcl/unix; ${MAKE} install-exec

TKXINSTALL:
	cd ../tk/unix; ${MAKE} install

TKXINSTALL_EXEC:
	cd ../tk/unix; ${MAKE} install-exec

# Targets to decide if we install wishx or not.

INST_WISHX: TKXINSTALL
INST_EXEC_WISHX: TKXINSTALL_EXEC

INST_:
INST_EXEC_:

#------------------------------------------------------------------------------
# Clean up all files that were built by make.

clean:
	cd ../tk/unix;  ${MAKE} clean
	cd ../tcl/unix; ${MAKE} clean
	cd tools;       ${MAKE} clean
	-rm -f runtcl runwishx


#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	cd ../tk/unix;  ${MAKE} distclean
	cd ../tcl/unix; ${MAKE} distclean
	cd tools;       ${MAKE} distclean
	rm -f Makefile config.status config.cache config.log Common.mk

# Disable Sun's parallel make, it doesn't get the dependencies right.
.NO_PARALLEL:
