#
# tktests/Makefile.in  --
#
# Makefile for Extended Tcl Tk tests.
# 
#------------------------------------------------------------------------------
# Copyright 1992-1995 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 1.1 1995/01/01 19:50:15 markd Exp markd $
#------------------------------------------------------------------------------
#
SHELL = /bin/sh

#------------------------------------------------------------------------------
# Autoconfig defines that can be overridden in Config.mk

CC          = @CC@
srcdir      = @srcdir@
srcbasedir  = @srcbasedir@
bldbasedir  = @bldbasedir@
VPATH       = @srcdir@
prefix      = @prefix@
exec_prefix = @exec_prefix@
XINCLUDES   = @XINCLUDES@
LIBS        = @LIBS@ @MATH_LIBS@
XLIBSW      = @XLIBSW@

#------------------------------------------------------------------------------
# Include user-editable defines.

@MAKEINCLUDE@ @MAKEQUOTE@${bldbasedir}/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------

LIBTCL_A     = ${bldbasedir}/tclmaster/lib${ARCH}/libtcl.a
LIBTCLX_A    = ${bldbasedir}/tclmaster/lib${ARCH}/libtclx.a
LIBTK_A      = ${bldbasedir}/tkmaster/lib${ARCH}/libtk.a
LIBTKX_A     = ${bldbasedir}/tkmaster/lib${ARCH}/libtkx.a

LDLIBS = ${LIBTKX_A} ${LIBTK_A} ${XLIBSW} ${LIBTCLX_A} ${LIBTCL_A} ${LIBS}

CC_FLAGS = ${CPPFLAGS} ${XCFLAGS} ${CFLAGS} \
           -I${srcbasedir}/src -I${bldbasedir}/src -I${srcbasedir}/tksrc \
           -I${TK_UCB_SRC} -I${TCL_UCB_SRC} ${XINCLUDES}

.c.o:
	${CC} ${CC_FLAGS} -c $<

#------------------------------------------------------------------------------

OBJS= tkXtest.o tkSquare.o

#------------------------------------------------------------------------------
# Compile the test proram.  It is generated from the Tk test program with 
# a sed script.
#

all: tkXtest runtest

tkXtest: tkXtest.o tkSquare.o ${LIBTKX_A} ${LIBTK_A} ${LIBTCLX_A} ${LIBTCL_A}
	${CC} ${CC_FLAGS} ${XLDFLAGS} tkXtest.o tkSquare.o ${LDLIBS} \
	    ${XLDLIBS} -o tkXtest || (rm -f tkXtest; exit 1)

tkXtest.o: tkXtest.c

tkSquare.o: tkSquare.c

tkXtest.c: ${TK_UCB_SRC}/tkTest.c
	rm -f tkXtest.c	
	echo '#include "../src/tclXconfig.h"' >tkXtest.c
	sed -e 's/Tcl_Init(/TclX_Init(/' \
	    -e 's/Tk_Init(/TkX_Init(/' \
	    -e 's/Tk_Main(/TkX_Main(/' \
	    -e '/tcl_RcFileName =/d' ${TK_UCB_SRC}/tkTest.c >>tkXtest.c

tkSquare.c: ${TK_UCB_SRC}/tkSquare.c
	rm -f tkSquare.c	
	echo '#include "../src/tclXconfig.h"' >tkSquare.c
	cat ${TK_UCB_SRC}/tkSquare.c >>tkSquare.c

#------------------------------------------------------------------------------
# Generate scripts to point the TCL_LIBRARY/TK_LIBRARY environment variable at
# the local master directories so tkXtest can be run.

runtest:
	@echo ':'                                                   >runtest
	@echo "TCL_LIBRARY=${bldbasedir}/tclmaster"                >>runtest
	@echo "TCL_PROGRAM=${bldbasedir}/tktests/tkXtest"          >>runtest
	@echo "TK_LIBRARY=${bldbasedir}/tkmaster"                  >>runtest
	@echo "export TCL_LIBRARY TK_LIBRARY TCL_PROGRAM"          >>runtest
	@echo "if [ \$$# = 0 ]"                                    >>runtest
	@echo "then"                                               >>runtest
	@echo "    exec \$$TCL_PROGRAM"                            >>runtest
	@echo "else"                                               >>runtest
	@echo "    exec \$$TCL_PROGRAM \"\$$@\""                   >>runtest
	@echo "fi"                                                 >>runtest
	chmod a+rx runtest

#------------------------------------------------------------------------------
# Run the UCB and Extended Tcl tests.

test: all
	echo "cd ${TK_UCB_SRC}/tests; source all; exit" | ./runtest -n tktest

tktest: test

#------------------------------------------------------------------------------

clean:
	-rm -f ${OBJS} tkXtest.c tkSquare.c tkXtest runtest

#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	rm -f Makefile
