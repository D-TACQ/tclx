#
# tk/unix/Makefile.in --
#
# Makefile to build a wish with Extended Tcl (wishx).
# 
#------------------------------------------------------------------------------
# Copyright 1992-1995 Karl Lehenbauer and Mark Diekhans.
#
# Permission to use, copy, modify, and distribute this software and its
# documentation for any purpose and without fee is hereby granted, provided
# that the above copyright notice appear in all copies.  Karl Lehenbauer and
# Mark Diekhans make no representations about the suitability of this
# software for any purpose.  It is provided "as is" without express or
# implied warranty.
#------------------------------------------------------------------------------
# $Id: Makefile.in,v 5.7 1996/02/09 18:43:59 markd Exp $
#------------------------------------------------------------------------------
#

#------------------------------------------------------------------------------
# Common and user-editable defines.
#
srcdir = @srcdir@
@MAKEINCLUDE@ @MAKEQUOTE@@bldbasedir@/unix/Common.mk@MAKEQUOTE@
@MAKEINCLUDE@ @MAKEQUOTE@@bldbasedir@/unix/Config.mk@MAKEQUOTE@

#------------------------------------------------------------------------------
# Local macros.

# The ordering of the libraries is important.  Some X libs on SysV include
# "random" in a BSD module.  This would conflict with the one in the TclX
# library if it was brought in.

LDLIBS = libtkx.a ${TK_LIB} ${XLIBSW} ${LIBTCLX} ${TCL_LIB} ${LIBS} \
         ${DL_LIBS} ${XLDLIBS}

SHLDLIBS = ${TKX_SHLIBS} ${XLIBSW} ${TCLX_SHLIBS} ${LIBS} ${XLDLIBS}

CC_SWITCHES = ${CPPFLAGS} ${XCFLAGS} ${CFLAGS} \
	      -I${TKX_GENERIC_DIR} \
	      -I${TK_GENERIC_DIR} -I${TK_UNIX_DIR} \
	      -I${TCLX_GENERIC_DIR} -I${TCLX_UNIX_SRC_DIR} \
	      -I${TCLX_UNIX_BLD_DIR} \
	      -I${TCL_GENERIC_DIR} -I${TCL_UNIX_DIR} \
	      ${XINCLUDES}

LD_SWITCHES = ${LDFLAGS} ${LD_FLAGS} ${XLDFLAGS} ${XCFLAGS} ${CFLAGS}

#------------------------------------------------------------------------------
# Source and target macros.
#
GENERIC_OBJS = tkXinit.o tkXshell.o

OBJS = ${GENERIC_OBJS}

LIBTCLX = ../../tcl/unix/libtclx.a

HELP_DIR = ${srcbasedir}/tk/help

DEMOSSRC  = ${TK_SRC}/library/demos
DEMOPROGS = browse hello ixset rmt rolodex square tcolor timer widget

TEST_OBJS = tktest.o tkSquare.o tkXtest.o

#------------------------------------------------------------------------------
# Dependencies for generating the libraries and linking the executable.
# If a link fails, purge the executable, as some systems leave invalid
# executables around.
#
all: libtkx.a wishx RUNTIME tktest runtest ${bldbasedir}/tk/tests

wishx: tkXAppInit.o libtkx.a ${LIBTK} ${TCL_LIB} ${TK_LIB}
	${CC} ${LD_SWITCHES} tkXAppInit.o ${LDLIBS} -o wishx || \
	    (rm -f wishx; exit 1)

libtkx.a: ${OBJS}
	${AR} cr libtkx.a ${OBJS}
	${RANLIB} libtkx.a

#------------------------------------------------------------------------------
# Dependencies for generating objects.
#
tkXinit.o: ${TKX_GENERIC_DIR}/tkXinit.c Makefile
	${CC} -c ${CC_SWITCHES} -DTKX_LIBRARY=\"${TKX_INST_MASTER}\" \
	  ${TKX_GENERIC_DIR}/tkXinit.c

tkXshell.o: ${TKX_GENERIC_DIR}/tkXshell.c
	${CC} -c ${CC_SWITCHES} ${TKX_GENERIC_DIR}/tkXshell.c

tkXAppInit.o: ${TKX_GENERIC_DIR}/tkXAppInit.c
	${CC} -c ${CC_SWITCHES} ${TKX_GENERIC_DIR}/tkXAppInit.c

#------------------------------------------------------------------------------
# Relink using shared libraries.  The libraries must be built and installed
# by hand.

shlink:
	${CC} ${LD_SWITCHES} tkXAppInit.o ${SHLDLIBS} -o wishx || \
	    (rm -f wishx; exit 1)

#------------------------------------------------------------------------------
# Generate the runtime .tlib library in the current directory.  Copy other
# runtime files into this directory so it can be used as a temporary runtime
# directory before installation.  Also need "help" and "demos" directory here
# so that the help and tkdemo commands will work before installation.
# Normally just symlink, unless we don't have them.
#
RUNTIME: tk.tlib tk.tndx tk.tcl prolog.ps tclhelp help demos

tk.tlib: ${TK_SRC}/library/tclIndex ${srcdir}/../runtime/tkdemo.tcl
	rm -f tk.tlib tk.tndx
	${CONVERTLIB} ${TK_SRC}/library/tclIndex tk.tlib
	rm -f tk.tndx
	cat ${srcdir}/../runtime/tkdemo.tcl >>tk.tlib

tk.tndx: tk.tlib
	${GENTNDX} tk.tlib

# Update tk.tcl to autoload from our library rather than explictly source
# the files.  We pick an entry point in each file to force it to be brought
# in.
tk.tcl: ${TK_SRC}/library/tk.tcl
	rm -f tk.tcl
	sed -f ${srcdir}/../runtime/tk.tcl.sed \
	    ${TK_SRC}/library/tk.tcl >tk.tcl

prolog.ps: ${TK_SRC}/library/prolog.ps
	rm -f prolog.ps
	cp ${TK_SRC}/library/prolog.ps prolog.ps

tclhelp: ${srcdir}/../runtime/tclhelp.tcl
	rm -f tclhelp
	echo "#!${TCL_BINDIR}/wishx"          >tclhelp
	cat ${srcdir}/../runtime/tclhelp.tcl >>tclhelp
	chmod +rx tclhelp

#------------------------------------------------------------------------------
# Need a "help" and "demos" directories in this directory so that the help and
# tkdemo commands will work before installation.  Normaly just symlink, unless
# we don't have them.# (Must enforce master dir being there, as a dependency
# on make.tmp causes it to be always rebuilt).

help:
	if [ "@HAVE_SYML@" = "YES" ]; then \
	    rm -rf help ;\
	    ln -s ${HELP_DIR} help ;\
	else \
	    rm -rf help ;\
	    (cd ${HELP_DIR}; tar -cf - help) | tar -xf - ;\
	fi

demos:
	if [ ! -d demos ] ; then mkdir demos ; else exit 0; fi
	${INSTCOPY} ${DEMOSSRC} demos
	@for i in $(DEMOPROGS); \
	    do \
	    rm -f demos/$$i; \
	    sed -e "s/^exec wish/exec wishx"/ ${DEMOSSRC}/$$i >demos/$$i; \
	    chmod 755 demos/$$i; \
	done;

#------------------------------------------------------------------------------
# Generate the test program.
#

tktest: ${TEST_OBJS} libtkx.a ${LIBTCLX}
	${CC} ${LD_SWITCHES} ${TEST_OBJS} ${LDLIBS} -o tktest || \
	    (rm -f tktest; exit 1)

tktest.o: tktest.c
	${CC} -c ${CC_SWITCHES} tktest.c

tkSquare.o: tkSquare.c
	${CC} -c ${CC_SWITCHES} tkSquare.c

tkXtest.o: ${TKX_GENERIC_DIR}/tkXtest.c
	${CC} -c ${CC_SWITCHES} ${TKX_GENERIC_DIR}/tkXtest.c

tktest.c: ${TK_SRC}/generic/tkTest.c
	rm -f tktest.c	
	echo '#include "../../tcl/unix/tclXconf.h"' >tktest.c
	cat ${TK_SRC}/generic/tkTest.c >>tktest.c

tkSquare.c: ${TK_SRC}/generic/tkSquare.c
	rm -f tkSquare.c	
	echo '#include "../../tcl/unix/tclXconf.h"'   >tkSquare.c
	cat ${TK_SRC}/generic/tkSquare.c >>tkSquare.c

#------------------------------------------------------------------------------
# Generate scripts to point the TCLX_LIBRARY/TKX_LIBRARY environment variable
# at the local master directories so tktest can be run.

runtest: Makefile
	@echo '#!/bin/sh'                                           >runtest
	@echo "TCLX_LIBRARY=${TCLX_TMP_MASTER}"                    >>runtest
	@echo "TKX_LIBRARY=${TKX_TMP_MASTER}"                      >>runtest
	@echo "TCL_PROGRAM=${TCLX_UNIX_BLD_DIR}/tcl"               >>runtest
	@echo "TESTWISH=${TKX_UNIX_BLD_DIR}/tktest"                >>runtest
	@echo "export TCLX_LIBRARY TKX_LIBRARY TCL_PROGRAM"        >>runtest
	@echo "if [ \$$# = 0 ]"                                    >>runtest
	@echo "then"                                               >>runtest
	@echo "    exec \$$TESTWISH"                               >>runtest
	@echo "else"                                               >>runtest
	@echo "    exec \$$TESTWISH \"\$$@\""                      >>runtest
	@echo "fi"                                                 >>runtest
	chmod a+rx runtest

#------------------------------------------------------------------------------
# If test directory in not in build tree, copy it from the source tree.
#
${bldbasedir}/tk/tests:
	mkdir ${bldbasedir}/tk/tests
	cp ${srcbasedir}/tk/tests/*.test ${bldbasedir}/tk/tests

#------------------------------------------------------------------------------
# Run the UCB tests with wishx.

test: all
	echo "cd ${TK_SRC}/tests; source all; exit" | ./runtest -n tktest

#------------------------------------------------------------------------------
# Build help for Tk.  These files are normally part of the distribution and
# not rebuilt by users.
#
buildhelp:
	rm -rf ${HELP_DIR} help
	mkdir ${HELP_DIR}
	${BLDMANHELP} ${TK_SRC}/doc ${srcbasedir}/unix/tools/tkmanpages \
	    ${HELP_DIR} Tk.brf

#------------------------------------------------------------------------------

install: install-exec install-runtime

install-runtime:
	${INSTCOPY} tk.tcl tk.tlib tk.tndx ${INSTALL_ROOT}${TKX_INST_MASTER}
	${INSTCOPY} ${TK_SRC}/library/prolog.ps \
	    ${INSTALL_ROOT}${TKX_INST_MASTER}
	${INSTCOPY} ${HELP_DIR} ${INSTALL_ROOT}${TKX_INST_MASTER}/help
	${INSTCOPY} demos ${INSTALL_ROOT}${TKX_INST_MASTER}/demos

install-exec:
	${INSTCOPY} wishx ${INSTALL_ROOT}${TCL_BINDIR}
	${STRIP} ${INSTALL_ROOT}${TCL_BINDIR}/wishx
	${INSTCOPY} libtkx.a ${INSTALL_ROOT}${TCL_LIBDIR}
	${RANLIB} ${INSTALL_ROOT}${TCL_LIBDIR}/libtkx.a
	${INSTCOPY} tkxlibs.mk ${INSTALL_ROOT}${TCL_LIBDIR}
	${INSTCOPY} tclhelp ${INSTALL_ROOT}${TCL_BINDIR}

install-master: install-runtime install-master-exec
	${INSTCOPY} ${TK_SRC}/generic/tk.h \
	    ${INSTALL_ROOT}${TKX_INST_MASTER}/include
	${SYMLINKEXT} ${TKX_INST_MASTER}/include/* \
	    ${INSTALL_ROOT}${TCL_INCLUDEDIR}
	${CPMANPAGES} @${MAN_DIR_SEPARATOR}@ \
	    ${TK_MAN_CMD_SECTION} ${TK_MAN_FUNC_SECTION} \
	    ${TK_MAN_UNIXCMD_SECTION} \
	    ${TK_SRC}/doc ${INSTALL_ROOT}${TKX_INST_MASTER}/man

install-master-exec:
	${INSTCOPY} wishx ${INSTALL_ROOT}${TKX_INST_MASTER}/bin${ARCH}
	${STRIP} ${INSTALL_ROOT}${TKX_INST_MASTER}/bin${ARCH}/wishx
	${INSTCOPY} ${LIBTK} libtkx.a \
	    ${INSTALL_ROOT}${TKX_INST_MASTER}/lib${ARCH}
	${RANLIB} ${INSTALL_ROOT}${TKX_INST_MASTER}/lib${ARCH}/*.a
	${INSTCOPY} tkxlibs.mk ${INSTALL_ROOT}${TKX_INST_MASTER}/lib${ARCH}
	${SYMLINKEXT} ${TKX_INST_MASTER}/bin${ARCH}/* \
	    ${INSTALL_ROOT}${TCL_BINDIR}
	${SYMLINKEXT} ${TKX_INST_MASTER}/lib${ARCH}/* \
	    ${INSTALL_ROOT}${TCL_LIBDIR}
	${INSTCOPY} tclhelp ${INSTALL_ROOT}${TKX_INST_MASTER}/bin${ARCH}
	${SYMLINKEXT} ${TKX_INST_MASTER}/bin${ARCH}/tclhelp \
	    ${INSTALL_ROOT}${TCL_BINDIR}

#------------------------------------------------------------------------------
clean:
	-rm -f tkXAppInit.o ${OBJS} ${TEST_OBJS} wishx libtkx.a
	-rm -f tktest.c tkSquare.c
	-rm -rf tk.tlib tk.tndx tk.tcl prolog.ps tclhelp help demos

#------------------------------------------------------------------------------
# Restore to the distributed state.

distclean: clean
	rm -f Makefile tkxlibs.mk runtest tktest

# Disable Sun's parallel make, it doesn't get the dependencies right.
.NO_PARALLEL:
